

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Introduction to concurrency using threads &#8212; Operating Systems</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lectures/09-concurrency';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lock and Condition Variables" href="10-lock-condition-variables.html" />
    <link rel="prev" title="Memory virtualization mechanism: paging and tlb" href="08-paging.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    CSC 331: Operating Systems
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01-introduction.html">Introduction to Operating Systems</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Virtualization</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="02-process.html">Abstraction: The process</a></li>
<li class="toctree-l1"><a class="reference internal" href="03-process-api.html">Process API</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-limited-direct-execution.html">Limited Direct Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="05-cpu-scheduling.html">CPU Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="06-memory-virtualization.html">Memory virtualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="07-address-translation.html">Memory virtualization mechanism: address translation</a></li>
<li class="toctree-l1"><a class="reference internal" href="08-paging.html">Memory virtualization mechanism: paging and tlb</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Concurrency</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Introduction to concurrency using threads</a></li>
<li class="toctree-l1"><a class="reference internal" href="10-lock-condition-variables.html">Lock and Condition Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="11-semaphores.html">Semaphores</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Persistence</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="12-io-disk-scheduling.html">I/O and Disks: Disk Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="13-file-systems.html">Introduction to file systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="14-crash-consistency-fsck-journaling.html">Crash consistency: fsck and journaling</a></li>
<li class="toctree-l1"><a class="reference internal" href="15-minix.html">Micro versus monolithnic kernels: Minix and Linux</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/lectures/09-concurrency.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Introduction to concurrency using threads</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#review-process-calls-fork">1. Review: process calls fork()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#review-process-context-switch">2. Review: process context switch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-web-server">3. Example: web server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thread-a-new-abstraction-for-running-processes">4. Thread: a new abstraction for running processes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thread-state-of-a-single-thread">5. Thread: state of a single thread</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-web-server-using-thread">6. Example: web server using thread</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#api-posix-threads-pthreads">7. API: POSIX threads (pthreads)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hands-on-say-hello-to-my-little-threads">8. Hands on: say hello to my little threads …</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hands-on-threads-and-gdb">9. Hands on: threads and gdb</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-problem-with-threads">10. The problem with threads</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#edward-lee-2006-the-problem-with-threads-computer-39-5">Edward Lee (2006). “The Problem with Threads”.  Computer 39(5).</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#challenge">11. Challenge</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="introduction-to-concurrency-using-threads">
<h1>Introduction to concurrency using threads<a class="headerlink" href="#introduction-to-concurrency-using-threads" title="Permalink to this heading">#</a></h1>
<section id="review-process-calls-fork">
<h2>1. Review: process calls fork()<a class="headerlink" href="#review-process-calls-fork" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>New PCB (process control block) and address space.</p></li>
<li><p>New address space is a copy of the entire contents of the parent’s
address space (up to fork).</p></li>
<li><p>Resources (file pointers) that point to parent’s resources.</p></li>
<li><p><strong>In general, time consuming.</strong></p></li>
</ul>
</section>
<section id="review-process-context-switch">
<h2>2. Review: process context switch<a class="headerlink" href="#review-process-context-switch" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Save A’s registers to A’s kernel stack.</p></li>
<li><p>Save A’s registers to A’s PCB.</p></li>
<li><p>Restore B’s registers from B’s PCB.</p></li>
<li><p>Switch to B’s kernel stack.</p></li>
<li><p>Restore B’s registers from B’s kernel stack.</p></li>
<li><p><strong>In general, time consuming.</strong></p></li>
</ul>
</section>
<section id="example-web-server">
<h2>3. Example: web server<a class="headerlink" href="#example-web-server" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>A process listens to requests.</p></li>
<li><p>When a new request comes in, a child process is created to
handle this request.</p></li>
<li><p>Multiple requests can be handled at the same time by
different child processes.</p></li>
<li><p>What is the problem?</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	  </span><span class="kt">int</span><span class="w"> </span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accept</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">fork</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">handle_request</span><span class="p">();</span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="thread-a-new-abstraction-for-running-processes">
<h2>4. Thread: a new abstraction for running processes<a class="headerlink" href="#thread-a-new-abstraction-for-running-processes" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>A normal process is a running program with a single point of execution,
i.e, a single PC (program counter).</p></li>
<li><p>A <strong>multi-threaded</strong> program has <strong>multiple points of execution</strong>, i.e., multiple PCs.</p></li>
<li><p>Each thread is very much like a separate process, except for one difference:</p>
<ul>
<li><p>All threads of the same process share the same address space and thus can
access the same data.</p></li>
</ul>
</li>
</ul>
<p>&lt;img src=”../fig/10-concurrency/01.png” alt=”pages” style=”height:350px”</p>
</section>
<section id="thread-state-of-a-single-thread">
<h2>5. Thread: state of a single thread<a class="headerlink" href="#thread-state-of-a-single-thread" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Each thread has its own PC.</p></li>
<li><p>Each thread has its own private set of registers for computation.</p></li>
<li><p>Context switching is still needed.</p></li>
<li><p>Threads use Thread Control Blocks (TCP) to store their execution states.</p></li>
<li><p>Context switching is similar to that of processes, except for:</p>
<ul>
<li><p>Thread context-switching keep the same address space (i.e., no need to switch out the page table).</p></li>
</ul>
</li>
</ul>
</section>
<section id="example-web-server-using-thread">
<h2>6. Example: web server using thread<a class="headerlink" href="#example-web-server-using-thread" title="Permalink to this heading">#</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">global_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">web_server</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accept</span><span class="p">();</span>
<span class="w">    </span><span class="n">thread_create</span><span class="p">(</span><span class="n">handle_request</span><span class="p">,</span><span class="w"> </span><span class="n">sock</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">handle_request</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">process</span><span class="w"> </span><span class="n">request</span><span class="p">;</span>
<span class="w">  </span><span class="o">++</span><span class="n">global_counter</span><span class="p">;</span>
<span class="w">  </span><span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="api-posix-threads-pthreads">
<h2>7. API: POSIX threads (pthreads)<a class="headerlink" href="#api-posix-threads-pthreads" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Standardized C language thread programming API.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pthreads</span></code> specifies the interface of using threads, but not how threads
are implemented in OS.</p></li>
<li><p>Different implementations include:</p>
<ul>
<li><p>kernel-level threads,</p></li>
<li><p>user-level threads, or</p></li>
<li><p>hybrid</p></li>
</ul>
</li>
<li><p><a class="reference external" href="http://man7.org/linux/man-pages/man3/pthread_create.3.html">pthread_create</a></p></li>
<li><p><a class="reference external" href="http://man7.org/linux/man-pages/man3/pthread_join.3.html">pthread_join</a></p></li>
</ul>
</section>
<section id="hands-on-say-hello-to-my-little-threads">
<h2>8. Hands on: say hello to my little threads …<a class="headerlink" href="#hands-on-say-hello-to-my-little-threads" title="Permalink to this heading">#</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="o">--</span><span class="n">userns</span><span class="o">=</span><span class="n">host</span><span class="w"> </span><span class="o">--</span><span class="n">cap</span><span class="o">-</span><span class="n">add</span><span class="o">=</span><span class="n">SYS_PTRACE</span><span class="w"> </span><span class="o">--</span><span class="n">security</span><span class="o">-</span><span class="n">opt</span><span class="w"> </span><span class="n">seccomp</span><span class="o">=</span><span class="n">unconfined</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">$USER</span><span class="o">/</span><span class="n">csc331</span><span class="o">:/</span><span class="n">home</span><span class="o">/</span><span class="n">$USER</span><span class="o">/</span><span class="n">csc331</span><span class="o">:</span><span class="n">Z</span><span class="w"> </span><span class="n">csc</span><span class="o">-</span><span class="n">container</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Create a directory named <code class="docutils literal notranslate"><span class="pre">concurrency</span></code> inside <code class="docutils literal notranslate"><span class="pre">~/csc331</span></code> and change to this directory</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>~/csc331/concurrency
<span class="nb">cd</span><span class="w"> </span>~/csc331/concurrency
</pre></div>
</div>
<ul class="simple">
<li><p>Create <code class="docutils literal notranslate"><span class="pre">thread_hello.c</span></code> with the following contents:</p></li>
</ul>
<script src="https://gist.github.com/linhbngo/d2f3a0b28b73a3f48c751410c6c91fd6.js?file=thread_hello.c"></script>
<ul class="simple">
<li><p>Compile and run <code class="docutils literal notranslate"><span class="pre">thread_hello.c</span></code>:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-o<span class="w"> </span>thread_hello<span class="w"> </span>thread_hello.c<span class="w"> </span>-lpthread
./thread_hello<span class="w"> </span><span class="m">1</span>
./thread_hello<span class="w"> </span><span class="m">2</span><span class="w"> </span>
./thread_hello<span class="w"> </span><span class="m">4</span>
</pre></div>
</div>
<img src="../fig/10-concurrency/02.png" alt="thread hello" style="height:400px">
</section>
<section id="hands-on-threads-and-gdb">
<h2>9. Hands on: threads and gdb<a class="headerlink" href="#hands-on-threads-and-gdb" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Recompile <code class="docutils literal notranslate"><span class="pre">thread_hello.c</span></code> with gdb support, then run <code class="docutils literal notranslate"><span class="pre">gdb</span></code>:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>thread_hello<span class="w"> </span>thread_hello.c<span class="w"> </span>-lpthread
gdb<span class="w"> </span>thread_hello
</pre></div>
</div>
<ul class="simple">
<li><p>We will set the breakpoint to the thread function <code class="docutils literal notranslate"><span class="pre">myThreadFun</span></code>, then run the
program with one command line argument.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gdb-peda$<span class="w"> </span>b<span class="w"> </span>myThreadFun
gdb-peda$<span class="w"> </span>run<span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
<ul class="simple">
<li><p>We are inside a thread</p></li>
</ul>
<img src="../fig/10-concurrency/03.png" alt="gdb thread hello" style="height:600px">
<ul class="simple">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">i</span> <span class="pre">threads</span></code> to see how many threads there are in total.</p></li>
<li><p>Then run <code class="docutils literal notranslate"><span class="pre">thread</span> <span class="pre">apply</span> <span class="pre">all</span> <span class="pre">bt</span></code> to learn more about the threads.</p></li>
<li><p>There are a total of three threads. Thread 1 comes from the main process. The other two
threads (2 and 3) where created from the <code class="docutils literal notranslate"><span class="pre">pthread_create</span></code> function call.</p></li>
<li><p>The numbered sections under the threads represent the stack frames.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gdb-peda$<span class="w"> </span>i<span class="w"> </span>threads
gdb-peda$<span class="w"> </span>thread<span class="w"> </span>apply<span class="w"> </span>all<span class="w"> </span>bt
</pre></div>
</div>
<img src="../fig/10-concurrency/04.png" alt="gdb thread backtrace" style="height:600px">
<ul class="simple">
<li><p>The outcomes of the previous command shows the stack frames of each thread.</p></li>
<li><p>We can use <code class="docutils literal notranslate"><span class="pre">thread</span> <span class="pre">i</span></code> to switch to thread <code class="docutils literal notranslate"><span class="pre">i</span></code>, then <code class="docutils literal notranslate"><span class="pre">frame</span> <span class="pre">j</span></code> to switch to the <code class="docutils literal notranslate"><span class="pre">j</span></code>&lt;supth&lt;/sup
of that thread.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">i</span> <span class="pre">locals</span></code> will print out all local variables of the current stack frame.</p></li>
<li><p>Continue running the followings:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gdb-peda$<span class="w"> </span>thread<span class="w"> </span><span class="m">1</span>
gdb-peda$<span class="w"> </span>i<span class="w"> </span>locals
gdb-peda$<span class="w"> </span>frame<span class="w"> </span><span class="m">1</span>
gdb-peda$<span class="w"> </span>i<span class="w"> </span>locals
gdb-peda$<span class="w"> </span>frame<span class="w"> </span><span class="m">3</span>
gdp-peda$<span class="w"> </span>i<span class="w"> </span>locals
</pre></div>
</div>
<img src="../fig/10-concurrency/05.png" alt="gdb thread backtrace" style="height:600px">
<ul class="simple">
<li><p>When a thread is created, the main process also turns into a management thread and holds to
wait for the child threads to finish (<code class="docutils literal notranslate"><span class="pre">pthread_join</span></code>). Each thread (including the main thread)
is located a segment on stack.</p></li>
<li><p>We can use <code class="docutils literal notranslate"><span class="pre">thread</span> <span class="pre">apply</span> <span class="pre">i</span> <span class="pre">a_command</span></code> to apply <code class="docutils literal notranslate"><span class="pre">a_command</span></code> to thread <code class="docutils literal notranslate"><span class="pre">i</span></code>.</p></li>
<li><p>Let’s advance thread 2 to next commmand:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb-peda$ thread 3
gdb-peda$ thread apply 3 n
gdb-peda$
</pre></div>
</div>
<ul class="simple">
<li><p>Scroll up a bit and observe. You will see a thread exited. Which thread is this?</p></li>
</ul>
<img src="../fig/10-concurrency/06.png" alt="gdb thread" style="height:600px">
<ul class="simple">
<li><p>What happened?</p></li>
<li><p>Switch back to thread 1, continue running <code class="docutils literal notranslate"><span class="pre">n</span></code> until you are back to the main process.</p></li>
</ul>
<img src="../fig/10-concurrency/07.png" alt="gdb thread" style="height:600px">
<ul class="simple">
<li><p>Keep running <code class="docutils literal notranslate"><span class="pre">n</span></code> to finish the program.</p></li>
</ul>
</section>
<section id="the-problem-with-threads">
<h2>10. The problem with threads<a class="headerlink" href="#the-problem-with-threads" title="Permalink to this heading">#</a></h2>
<section id="edward-lee-2006-the-problem-with-threads-computer-39-5">
<h3>Edward Lee (2006). “The Problem with Threads”.  Computer 39(5).<a class="headerlink" href="#edward-lee-2006-the-problem-with-threads-computer-39-5" title="Permalink to this heading">#</a></h3>
<p>From a fundamental perspective, threads are seriously flawed
as a computation model because they are wildly nondeterministic…
The programmer’s job is to prune away that nondeterminism. We have
developed tools to assist in the pruning: semaphores, monitors, and
more modern overlays on threads offer the programmer ever more effective
pruning. But pruning a wild mass of brambles rarely yields a satisfactory
hedge. To offer another analogy, a folk definition of insanity is to do
the same thing over and over again and expect the results to be different.
By this definition, we in fact require that programmers of multithreaded
systems be insane. Were they sane, they could not understand their programs.`</p>
</section>
</section>
<section id="challenge">
<h2>11. Challenge<a class="headerlink" href="#challenge" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Inside <code class="docutils literal notranslate"><span class="pre">concurrency</span></code>, change to this directory, and create <code class="docutils literal notranslate"><span class="pre">thread_matrix.c</span></code> with
the following contents:</p></li>
</ul>
<script src="https://gist.github.com/linhbngo/d2f3a0b28b73a3f48c751410c6c91fd6.js?file=thread_matrix.c"></script>
<ul class="simple">
<li><p>Compile <code class="docutils literal notranslate"><span class="pre">thread_matrix.c</span></code> with <code class="docutils literal notranslate"><span class="pre">-g</span></code> then run the program inside <code class="docutils literal notranslate"><span class="pre">gdb</span></code> with
the breakpoint set to the <code class="docutils literal notranslate"><span class="pre">matrix_mul</span></code> function.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> command should accept 4 as a command line argument.</p></li>
<li><p>Perform the following tasks:</p>
<ul>
<li><p>Identify the index of the first C cell on which thread 3 will operate ?</p></li>
<li><p>Check the value inside this index from thread 2.</p></li>
<li><p>Inside thread 3, advance until the value inside this cell has been modified.</p></li>
<li><p>Check that the value from thread 2 is modified as well.</p></li>
<li><p>Also check that values of start and end are different inside 2 and 3.</p></li>
</ul>
</li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="08-paging.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Memory virtualization mechanism: paging and tlb</p>
      </div>
    </a>
    <a class="right-next"
       href="10-lock-condition-variables.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lock and Condition Variables</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#review-process-calls-fork">1. Review: process calls fork()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#review-process-context-switch">2. Review: process context switch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-web-server">3. Example: web server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thread-a-new-abstraction-for-running-processes">4. Thread: a new abstraction for running processes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thread-state-of-a-single-thread">5. Thread: state of a single thread</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-web-server-using-thread">6. Example: web server using thread</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#api-posix-threads-pthreads">7. API: POSIX threads (pthreads)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hands-on-say-hello-to-my-little-threads">8. Hands on: say hello to my little threads …</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hands-on-threads-and-gdb">9. Hands on: threads and gdb</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-problem-with-threads">10. The problem with threads</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#edward-lee-2006-the-problem-with-threads-computer-39-5">Edward Lee (2006). “The Problem with Threads”.  Computer 39(5).</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#challenge">11. Challenge</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Linh Ngo
</p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"></a> <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Introduction to Cloud Computing</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.
</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>